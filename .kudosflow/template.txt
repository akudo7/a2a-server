<specification>
# SceneGraphManager A2A SDKç§»è¡Œè¨ˆç”»

## ğŸ“‹ æ¦‚è¦

SceneGraphManagerã®ç‹¬è‡ªA2Aå®Ÿè£…ã‚’å…¬å¼A2A SDKã«ç½®ãæ›ãˆã€æ¨™æº–æº–æ‹ ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ğŸ¯ ç§»è¡Œç›®æ¨™

- **æ¨™æº–æº–æ‹ **: å…¬å¼A2A Protocolæº–æ‹ 
- **æ©Ÿèƒ½æ‹¡å¼µ**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€Pushé€šçŸ¥ã€èªè¨¼ã‚µãƒãƒ¼ãƒˆ
- **ä¿å®ˆæ€§å‘ä¸Š**: å…¬å¼SDKä½¿ç”¨ã«ã‚ˆã‚‹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è² è·è»½æ¸›
- **äº’æ›æ€§ç¶­æŒ**: æ—¢å­˜æ©Ÿèƒ½ã®å‹•ä½œä¿è¨¼

## ğŸ“ å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### Phase 1: ä¾å­˜é–¢ä¿‚ã¨ã‚³ã‚¢å®Ÿè£…ã®æ›´æ–°

```
1. package.json                                          [ä¾å­˜é–¢ä¿‚å¤‰æ›´]
2. src/SceneGraphManager/lib/models/factory.ts           [A2Açµ±åˆæ›´æ–°]
3. src/SceneGraphManager/a2a/A2AClient.ts               [å‰Šé™¤]
4. src/SceneGraphManager/a2a/A2AEndpoint.ts             [å¤§å¹…å¤‰æ›´]
5. src/SceneGraphManager/a2a/A2AToolGenerator.ts        [SDKçµ±åˆ]
6. src/SceneGraphManager/a2a/types/index.ts             [ç°¡ç´ åŒ–]
7. src/SceneGraphManager/types/a2a.ts                   [SDKå‹çµ±åˆ]
```

### Phase 2: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

```
8. json/research/main.json                              [A2Aè¨­å®šæ›´æ–°]
9. json/research/quality-evaluation.json               [ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ›´æ–°]
10. json/research/research-execution.json              [ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ›´æ–°]
11. json/research/task-creation.json                   [ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ›´æ–°]
```

### Phase 3: CLIçµ±åˆã®èª¿æ•´

```
12. src/kudos.tsx                                       [è»½å¾®èª¿æ•´]
```

## ğŸ”„ æ®µéšçš„ç§»è¡Œæˆ¦ç•¥

### **Phase 1: ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ç§»è¡Œ**Â (å„ªå…ˆåº¦: é«˜)

### 1.1 ä¾å­˜é–¢ä¿‚ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `package.json`

```
- "axios": "^1.11.0",
- "@types/axios": "^0.14.4",
+ "@a2a-js/sdk": "^latest",
+ "express": "^4.x.x",  // peer dependency
```

### 1.2 A2Aã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã®ç½®ãæ›ãˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `src/SceneGraphManager/a2a/A2AClient.ts`

[å‰Šé™¤] - å…¬å¼SDKã®A2AClientã‚’ä½¿ç”¨

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `src/SceneGraphManager/a2a/A2AToolGenerator.ts`

```tsx
// å¤‰æ›´å‰
import { A2AClient } from "./A2AClient.js";

// å¤‰æ›´å¾Œ
import { A2AClient } from "@a2a-js/sdk/client";
```

### 1.3 ModelFactoryManagerã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `src/SceneGraphManager/lib/models/factory.ts`

```tsx
// ä¸»è¦å¤‰æ›´ç‚¹
- import { A2AClient } from "../../a2a/A2AClient.js";
+ import { A2AClient } from "@a2a-js/sdk/client";

// SDKæº–æ‹ ã®APIä½¿ç”¨
static async configureA2A(config) {
  const client = await A2AClient.fromCardUrl(config.url);
  // ...
}
```

### **Phase 2: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¨™æº–åŒ–**Â (å„ªå…ˆåº¦: ä¸­)

### 2.1 A2Aã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šã®æ¨™æº–åŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `json/research/main.json`

```json
{
  "a2aClients": {
    "task_agent": {
      "cardUrl": "http://localhost:3001/.well-known/agent-card.json",
      "timeout": 30000
    }
  }
}
```

### 2.2 A2Aã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®šã®AgentCardæº–æ‹ 

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `json/research/*-*.json`

```json
{
  "config": {
    "a2aEndpoint": {
      "agentCard": {
        "name": "TaskCreationAgent",
        "description": "...",
        "url": "http://localhost:3001",
        "version": "1.0.0",
        "capabilities": {
          "streaming": false,
          "pushNotifications": false,
          "stateTransitionHistory": true
        },
        "skills": [...]
      },
      "port": 3001
    }
  }
}
```

### **Phase 3: çµ±åˆãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´**Â (å„ªå…ˆåº¦: ä½)

### 3.1 CLIçµ±åˆã®èª¿æ•´

**ãƒ•ã‚¡ã‚¤ãƒ«**:Â `src/kudos.tsx`

```tsx
// å¿…è¦ã«å¿œã˜ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆèª¿æ•´
// åŸºæœ¬çš„ã«ã¯å¤‰æ›´ä¸è¦
```

## âš ï¸ é‡è¦ãªå¤‰æ›´ç‚¹

### APIå¤‰æ›´

| å¾“æ¥ | A2A SDK | å½±éŸ¿ |
| --- | --- | --- |
| `client.discover(url)` | `A2AClient.fromCardUrl(cardUrl)` | åˆæœŸåŒ–æ–¹æ³•å¤‰æ›´ |
| `client.sendTask()` | `client.sendMessage()` | ãƒ¡ã‚½ãƒƒãƒ‰åå¤‰æ›´ |
| ã‚«ã‚¹ã‚¿ãƒ JSON-RPC | æ¨™æº–A2A Protocol | ãƒ—ãƒ­ãƒˆã‚³ãƒ«å¤‰æ›´ |

### æ–°æ©Ÿèƒ½è¿½åŠ 

- **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**:Â `client.sendMessageStream()`
- **Pushé€šçŸ¥**:Â `pushNotificationConfig`
- **èªè¨¼**:Â `AuthenticationHandler`
- **ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«**:Â `client.cancelTask()`

### å‰Šé™¤ã•ã‚Œã‚‹æ©Ÿèƒ½

- ç‹¬è‡ªå®Ÿè£…ã®JSON-RPCãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆSDKæ¨™æº–ã«ç§»è¡Œï¼‰

## ğŸ“ˆ ç§»è¡Œãƒ¡ãƒªãƒƒãƒˆ

### å³åº§ã®ãƒ¡ãƒªãƒƒãƒˆ

- âœ… å…¬å¼ã‚µãƒãƒ¼ãƒˆãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
- âœ… æ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«æº–æ‹ 
- âœ… ãƒã‚°ä¿®æ­£ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°

### å°†æ¥ã®ãƒ¡ãƒªãƒƒãƒˆ

- ğŸš€ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ
- ğŸ”” Pushé€šçŸ¥æ©Ÿèƒ½
- ğŸ” èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ»ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹å¯¾å¿œ

## ğŸ’¡ æ¨å¥¨å®Ÿè£…é †åº

1. **`package.json`**Â - ä¾å­˜é–¢ä¿‚æ›´æ–°
2. **`factory.ts`**Â - A2Açµ±åˆã®æ ¸å¿ƒéƒ¨åˆ†
3. **`A2AClient.ts`**Â - å‰Šé™¤ï¼ˆSDKä½¿ç”¨ï¼‰
4. **`A2AToolGenerator.ts`**Â - SDKçµ±åˆ
5. **`A2AEndpoint.ts`**Â - ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…æ›´æ–°
6. **`types/a2a.ts`**Â - å‹å®šç¾©èª¿æ•´
7. **JSONè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¾¤**Â - è¨­å®šæ¨™æº–åŒ–
8. **`kudos.tsx`**Â - æœ€çµ‚èª¿æ•´

## ğŸ” è©³ç´°å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### Phase 1: ä¾å­˜é–¢ä¿‚ã¨ã‚³ã‚¢å®Ÿè£…

### ã‚¹ãƒ†ãƒƒãƒ— 1: package.jsonæ›´æ–°

```tsx
{
  "dependencies": {
    "@a2a-js/sdk": "^latest",
    "express": "^4.x.x"
  }
}
```

**å‰Šé™¤**:Â `axios`,Â `@types/axios`,Â `@types/express`

### ã‚¹ãƒ†ãƒƒãƒ— 2: ModelFactoryManageræ›´æ–°

```tsx
// src/SceneGraphManager/lib/models/factory.ts
import { A2AClient } from "@a2a-js/sdk/client";

static async configureA2A(a2aConfig: Record<string, { cardUrl: string; timeout?: number }>) {
  for (const [agentName, config] of Object.entries(a2aConfig)) {
    const client = await A2AClient.fromCardUrl(config.cardUrl, {
      fetchImpl: fetch // ã‚«ã‚¹ã‚¿ãƒ fetchè¨­å®šå¯èƒ½
    });
    this.a2aClients.set(agentName, client);
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ— 3: A2AToolGenerator SDKçµ±åˆ

```tsx
// src/SceneGraphManager/a2a/A2AToolGenerator.ts
import { A2AClient, MessageSendParams } from "@a2a-js/sdk/client";
import { DynamicTool } from "@langchain/core/tools";

export class A2AToolGenerator {
  static generateToolsWithUrlMap(
    clients: Map<string, A2AClient>,
    urlMap: Record<string, { cardUrl: string }>
  ): Tool[] {
    const tools: Tool[] = [];
    
    for (const [agentName, client] of clients) {
      // Send Message Tool (SDKæº–æ‹ )
      const sendMessageTool = new DynamicTool({
        name: `send_message_to_${agentName}`,
        description: `Send a message to ${agentName} agent`,
        func: async (input: any) => {
          const params: MessageSendParams = {
            message: {
              messageId: uuidv4(),
              role: "user",
              parts: [{ kind: "text", text: input.message }],
              kind: "message"
            }
          };
          
          const response = await client.sendMessage(params);
          return JSON.stringify(response);
        }
      });
      
      tools.push(sendMessageTool);
    }
    
    return tools;
  }
}
```

### Phase 2: ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…ã®æ›´æ–°

### ã‚¹ãƒ†ãƒƒãƒ— 4: A2AEndpoint SDKæº–æ‹ å®Ÿè£…

```tsx
// src/SceneGraphManager/a2a/A2AEndpoint.ts
import express from "express";
import { 
  AgentExecutor,
  RequestContext,
  ExecutionEventBus,
  DefaultRequestHandler,
  InMemoryTaskStore,
  A2AExpressApp
} from "@a2a-js/sdk/server";
import type { AgentCard } from "@a2a-js/sdk";

export class A2AEndpoint {
  private agentCard: AgentCard;
  private executor: AgentExecutor;
  
  constructor(config: A2AEndpointConfig) {
    this.agentCard = {
      name: config.name,
      description: config.description,
      protocolVersion: "0.3.0",
      version: "1.0.0",
      url: `http://localhost:${config.port}/`,
      skills: config.skills || [],
      capabilities: {
        streaming: false,
        pushNotifications: false,
        stateTransitionHistory: true
      }
    };
    
    this.executor = new CustomAgentExecutor(config.executor);
  }
  
  public run(port: number = 3000): void {
    const taskStore = new InMemoryTaskStore();
    const requestHandler = new DefaultRequestHandler(
      this.agentCard,
      taskStore,
      this.executor
    );
    
    const appBuilder = new A2AExpressApp(requestHandler);
    const app = appBuilder.setupRoutes(express());
    
    app.listen(port, () => {
      console.log(`A2A Endpoint running on port ${port}`);
    });
  }
}

class CustomAgentExecutor implements AgentExecutor {
  constructor(private userExecutor: Function) {}
  
  async execute(
    requestContext: RequestContext,
    eventBus: ExecutionEventBus
  ): Promise<void> {
    const result = await this.userExecutor(
      requestContext.message.parts[0].text,
      requestContext.sessionId
    );
    
    eventBus.publish({
      kind: "message",
      messageId: uuidv4(),
      role: "agent",
      parts: [{ kind: "text", text: result }],
      contextId: requestContext.contextId
    });
    
    eventBus.finished();
  }
  
  cancelTask = async (): Promise<void> => {};
}
```

### Phase 3: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¨™æº–åŒ–

### ã‚¹ãƒ†ãƒƒãƒ— 5: JSONè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°

**main.json**:

```tsx
{
  "a2aClients": {
    "task_agent": {
      "cardUrl": "http://localhost:3001/.well-known/agent-card.json",
      "timeout": 30000
    },
    "research_agent": {
      "cardUrl": "http://localhost:3002/.well-known/agent-card.json",
      "timeout": 30000
    },
    "quality_agent": {
      "cardUrl": "http://localhost:3003/.well-known/agent-card.json",
      "timeout": 30000
    }
  }
}
```

**å„ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®š**:

```tsx
{
  "config": {
    "a2aEndpoint": {
      "agentCard": {
        "name": "TaskCreationAgent",
        "description": "Creates and manages research tasks",
        "protocolVersion": "0.3.0",
        "version": "1.0.0",
        "url": "http://localhost:3001/",
        "capabilities": {
          "streaming": false,
          "pushNotifications": false,
          "stateTransitionHistory": true
        },
        "skills": [
          {
            "id": "task_creation",
            "name": "Task Creation",
            "description": "Break down research requests into tasks"
          }
        ]
      },
      "port": 3001
    }
  }
}
```

## ğŸš€ æ–°æ©Ÿèƒ½æ´»ç”¨ä¾‹

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ

```tsx
// å°†æ¥ã®æ‹¡å¼µä¾‹
const stream = client.sendMessageStream({
  message: {
    messageId: uuidv4(),
    role: "user",
    parts: [{ kind: "text", text: "ç ”ç©¶ã‚’é–‹å§‹ã—ã¦ãã ã•ã„" }],
    kind: "message"
  }
});

for await (const event of stream) {
  console.log("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°:", event);
}
```

### Pushé€šçŸ¥å¯¾å¿œ

```tsx
// é•·æ™‚é–“ã‚¿ã‚¹ã‚¯ç”¨Pushé€šçŸ¥
const response = await client.sendMessage({
  message: {
    messageId: uuidv4(),
    role: "user",
    parts: [{ kind: "text", text: "è©³ç´°ãªå¸‚å ´èª¿æŸ»ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" }],
    kind: "message"
  },
  configuration: {
    pushNotificationConfig: {
      url: "https://your-app.com/webhook/task-updates",
      token: "your-auth-token"
    }
  }
});
```

### èªè¨¼å¯¾å¿œ

```tsx
// èªè¨¼ä»˜ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
import { createAuthenticatingFetchWithRetry, AuthenticationHandler } from "@a2a-js/sdk/client";

const authHandler: AuthenticationHandler = {
  headers: async () => ({
    Authorization: `Bearer ${await getToken()}`
  }),
  shouldRetryWithHeaders: async (req, res) => {
    if (res.status === 401) {
      const newToken = await refreshToken();
      return { Authorization: `Bearer ${newToken}` };
    }
    return undefined;
  }
};

const authFetch = createAuthenticatingFetchWithRetry(fetch, authHandler);
const client = await A2AClient.fromCardUrl(cardUrl, { fetchImpl: authFetch });
```
</specification>

<Project>
```plain text
${{kudosflow_tree}}
```
</Project>

<${{kudosflow_filename}}>
```typescript
${{kudosflow_content}}
```
</${{kudosflow_filename}}>

QUERYï¼š ${{kudosflow_query}}

<LOG>
```bash
${{kudosflow_terminal}}
```
</LOG>

CAUTION:
Show a list of file names with full path, if answering a question requires checking specific files in the project. Do not provide an answer before checking.
And if there are multiple files that need to be edited, confirm with the user which file should be edited. 
Make the modifications minimal and do not add any new features.